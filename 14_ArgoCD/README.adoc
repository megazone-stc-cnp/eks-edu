= 14. ArgoCD
// Settings:
:experimental:
:icons: font
:sectnums:
// :!sectids:
// Github?
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
// No Github?
ifndef::env-github[]
:toc: left
:toclevels: 4
:source-highlighter: highlight.js
endif::[]
:revealjsdir: https://cdn.jsdelivr.net/npm/reveal.js
:revealjs_showSlideNumber: all
:revealjs_hash: true
// Presentation 변환 참고용
// - https://asciidoc-slides.8vi.cat/
// - https://zenika.github.io/adoc-presentation-model/reveal-my-asciidoc.html

== 목표
- ArgoCD에 대해서 배우고, ArgoCD를 설치합니다.
- ArgoCD에 Application을 배포 실습 합니다.

== 사전 조건
. link:00_Setup/[0. 교육 환경 구성하기]를 이용해 기본 실습 환경 생성이 되어 있어야 합니다.
. link:00_Setup/[0. 교육 환경 구성하기]를 이용해 생성된 `code-server`에 접속한 상태여야 합니다.
. link:14_Application/[14. ArgoCD]에 00_pre_setup/01_install.sh 를 실행하여 EBS CSI DRiver/EFS CSI Driver Addon이 같이 설치된 EKS를 구축합니다.
[source,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/00_pre_setup
sh 01_install.sh
----
. link:11_Network_2/[11. Network_2]에 `create-aws-lbc-irsa.sh`를 실행하여 AWS LBC Controller를 설치합니다.
[source,shell]
----
cd ~/environment/eks-edu/11_Network_2/
sh create-aws-lbc-irsa.sh

helm repo add eks https://aws.github.io/eks-charts
helm repo update eks

source ../env.sh

helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=$CLUSTER_NAME \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-lbc-sa \
  --version 1.13.2
----
== 이론

=== Architecture
image::images/ArgoCD-Architecture.png[ArgoCD Architecture]

=== ArgoCD 기능
- **지정된 대상 환경으로의 애플리케이션 자동 배포**
- **Kustomize, Helm, plain YAML**,Jsonnet 등 다양한 설정 관리 및 템플릿 도구 지원
- **여러 클러스터에 대한 관리 및 배포** 기능
- OIDC, OAuth2, LDAP, SAML 2.0, GitHub, GitLab, Microsoft, LinkedIn 등과의 **SSO(싱글 사인온) 연동**
- 멀티 테넌시 및 **RBAC(역할 기반 접근 제어) 정책을 통한 권한 관리**
- Git 저장소에 커밋된 애플리케이션 구성으로의 롤백 및 임의 버전 롤포워드 지원
- **애플리케이션 리소스의 상태 및 헬스 분석** 기능
- 구성 드리프트 자동 감지 및 시각화
- 애플리케이션을 원하는 상태로 자동 또는 수동 동기화
- 실시간 애플리케이션 활동을 확인할 수 있는 웹 UI 제공
- 자동화 및 CI 통합을 위한 CLI(Command Line Interface) 지원
- GitHub, BitBucket, GitLab과의 웹훅 연동
- 자동화를 위한 액세스 토큰 제공
- PreSync, Sync, PostSync 훅을 통한 블루/그린, 카나리 배포 등 복잡한 롤아웃 전략 지원
- 애플리케이션 이벤트 및 API 호출에 대한 감사 로그 제공
- Prometheus 기반의 모니터링 지표 제공
- **Git 내 Helm 파라미터를 재정의할 수 있는 파라미터 오버라이드 기능 지원**

=== Argo CD Component

.Component 종류
[%autowidth,cols="1s,a"]
|===
|이름 |설명

|Argo CD Server
|gRPC / Rest API 서버

|Application Controller
|어플리케이션의 상태와 타켓 클러스터 상태 모니터링


|ApplicationSet Controller
|멀티 타겟용 어플리케이션 셋 관리

|Repo Server
|Git Repo 동기화

|Dex Server
|OIDC 인증 관리

|Redis
|리소스 Caching

|Notifications Controller
|알림 관리
|===

== 실습
=== ArgoCD 서버 설치
. argocd repo 등록
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/01_argo_install_http
sh 01_argocd_repo_add.sh
----
+
위 ``01_argocd_repo_add.sh``를 실행하면 ``helm repo add`` 명령어로 repo를 등록 합니다.(참고용)
+
[,shell]
----
# 배포
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update
----
+
.실행 화면
image::images/argocd_helm_repo_add.png[ArgoCD Helm Repo 추가]

. Helm Version 체크
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/01_argo_install_http
sh 02_argocd_helm_version.sh
----
+
위 ``sh 02_argocd_helm_version.sh``를 실행하면 ``helm search repo`` 명령어로 Version 목록을 출력합니다 . Helm 설치할 때 파라미터로 입력이 필요합니다.(참고용)
+
[,shell]
----
# 배포
helm search repo argo/argo-cd --versions
----
+
.실행 화면
image::images/argocd_helm_search_repo.png[Helm Chart 목록 조회]

. Helm 설치
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/01_argo_install_http
sh 03_helm_install.sh 8.1.0
----
+
위 ``sh 03_helm_install.sh``를 실행하면 ``tmp/custom_values.yaml`` 파일을 생성하여 ``argocd`` Namespace를 생성하여 ``my-argocd`` App을 생성합니다. (참고용)
+
[,shell]
----
# 배포
helm -n argocd upgrade --install my-argocd \
    argo/argo-cd \
    --create-namespace \
    -f tmp/custom_values.yaml \
    --version 8.1.0
----
+
.실행 화면
image::images/argocd_helm_install.png[ArgoCD Helm Install]

. Admin 계정 초기 패스워드 조회
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/01_argo_install_http
sh 04_get_initial_password.sh
----
+
위 ``sh 04_get_initial_password.sh``를 실행하면 아래의 명령으로 Admin 계정의 초기 패스워드를 조회합니다. (참고용)
+
[,shell]
----
# 배포
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
----
+
.실행 화면
image::images/CleanShot 2025-06-17 at 10.45.45.png[초기 패스워드 조회]

. ArgoCD 접속용 Ingress 조회
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/01_argo_install_http
sh 05_get_ingress.sh
----
+
위 ``sh 05_get_ingress.sh``를 실행하면 ArgoCD 웹페이지를 접속할 URL를 조회합니다. (참고용)
+
[,shell]
----
# 배포
kubectl get ingress -n argocd
----
+
.실행 화면
image::images/argocd_get_ingress.png[ArgoCD Ingress 조회]
+
.사이트 접속 화면
image::images/argocd_web_site.png[ArgoCD 웹 사이트]

=== User 등록
. argocd CLI 로그인
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/02_argocd_login/
sh 01_login.sh
----
+
위 ``01_login.sh``를 실행하면 ``argocd login`` 명령어로 로그인을 한다.(참고용)
+
[,shell]
----
# 배포
argocd login k8s-argocd-myargocd-bc80709364-1978875625.ap-northeast-2.elb.amazonaws.com:80 --insecure --username admin --skip-test-tls --plaintext --grpc-web

Password:
----
+
.실행 화면
image::images/argocd_cli_login.png[ArgoCD CLI 로그인]

. user1 User 등록
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/02_argocd_login
sh 02_user_add.sh <ADMIN Password>
----
+
위 ``02_user_add.sh``를 실행하면 ``argocd-cm`` ConfigMaps에 등록 하고 ``admin123!`` 패스워드를 변경한다.(참고용)
+
[,shell]
----
kubectl -n argocd patch configmap argocd-cm \
  --type merge \
  -p "{\"data\": {\"accounts.user1\": \"apiKey, login\"}}"

argocd account update-password \
        --account user1 \
        --current-password admin123! \
        --new-password admin123!

kubectl -n argocd rollout restart deployment my-argocd-server
----
+
.실행 화면
image::images/argocd_user_add.png[ArgoCD User 등록]

>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

. argocd repo 등록
+
[,shell]
----
cd ~/environment/eks-edu/14_ArgoCD/02_argocd_login
sh 04_user_permission.sh
----
+
위 ``04_user_permission.sh``를 실행하면 ``argocd-rbac-cm`` ConfigMaps에 user의 권한을 등록 합니다.(참고용)
+
[,shell]
----
kubectl -n argocd patch configmap argocd-rbac-cm \
  --type merge \
  -p $"{\"data\":{\"policy.csv\":\"g, user1, role:admin\n\"}}"
----
+
.실행 화면
image::images/argocd_user_permission.png[ArgoCD User Permission]

=== Application 등록

==== Repository 등록

. Settings > Repositories 클릭
+
image::images/argocd_register_repository.png[Repository 등록]

. CONNECT REPO 클릭
+
image::images/argocd_connect_repo.png[CONNECT REPO 클릭]

. Repository 등록
+
.. 아래 내용을 등록 후 CONNECT 버튼 클릭
... Choose your connection method : VIA HTTP/HTTPS
... Type : git
... Name : test
... Project : default
... Repository URL : https://github.com/megazone-hcseo/test.git
... Username : <Public Repo이므로 불필요>
... Password : <Public Repo이므로 불필요>

. 연결 상태 확인
+
image::images/argocd_repository_status_check.png[연결 상태 확인]

. Application 등록
+
image::images/argocd_create_application.png[Application 등록]

. Application 등록
+
.. 아래 내용을 등록 후 CREATE 버튼 클릭
... Application Name : test
... Project Name : default
... SYNC POLICY : Automatic
... Repository URL : https://github.com/megazone-hcseo/test.git
... Revision : HEAD
... Cluster URL : https://kubernetes.default.svc
... Namespace : default

. Application 생성 확인
+
image::images/Application_create_result.png[Application 생성 확인]

== 관련 링크
- [ArgoCD 공식 문서](https://argo-cd.readthedocs.io/en/stable/)
- [argocd repo add Command Reference](https://argo-cd.readthedocs.io/en/stable/user-guide/commands/argocd_repo_add/)